{% extends 'base.html.twig' %}

{% block body %}
    {% form_theme form 'bootstrap_5_layout.html.twig' %}
    <div class="container py-5">
        <h1 class="text-center text-dark mb-4">Créer des pointages multiples</h1>

        <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-lg-5">
                {{ form_start(form, {
                    attr: { class: 'bg-white p-4 p-md-5 rounded-3 shadow-sm', id: 'multi-clocking-form' }
                }) }}

                {{ form_errors(form) }}

                <div class="mb-3">
                    {{ form_row(form.date) }}
                </div>

                <div class="mb-4">
                    {{ form_row(form.project) }}
                </div>

                <h3 class="h5 text-secondary mb-3">Collaborateurs à pointer</h3>

                {% set proto %}
                    {{ form_row(form.entries.vars.prototype.user, { label: 'Collaborateur' }) }}
                    {{ form_row(form.entries.vars.prototype.duration) }}
                {% endset %}

                <div id="entries-wrapper"
                     class="d-flex flex-column"
                     data-prototype="{{ proto|e('html_attr') }}">
                    {% for entryForm in form.entries %}
                        <div class="entry-item bg-light border rounded-3 p-3 mb-3">
                            <div class="mb-3">
                                {{ form_row(entryForm.user, { label: 'Collaborateur' }) }}
                            </div>
                            <div>
                                {{ form_row(entryForm.duration) }}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="mt-2">
                    <button type="button" id="add-entry" class="btn btn-outline-secondary">
                        + Ajouter un collaborateur
                    </button>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-dark">
                        Valider
                    </button>
                </div>

                {{ form_end(form) }}
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const wrapper = document.getElementById('entries-wrapper');
            const addButton = document.getElementById('add-entry');
            let index = {{ form.entries|length }};

            function addEntry() {
                const prototype = wrapper.dataset.prototype;
                if (!prototype) return;

                const newFormHtml = prototype.replace(/__name__/g, index);

                const entryDiv = document.createElement('div');
                entryDiv.className = 'entry-item bg-light border rounded-3 p-3 mb-3';
                entryDiv.innerHTML = newFormHtml;

                wrapper.appendChild(entryDiv);
                index++;
            }

            if (index === 0) addEntry();
            addButton.addEventListener('click', addEntry);
        });
    </script>
{% endblock %}
